name: CI
on:
  push:
    branches:
      - 'master'
      - 'release-[0-9]+.[0-9]+'
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches:
      - 'master'
      - 'release-[0-9]+.[0-9]+'

# Cancel any in-progress CI runs for a PR if it is updated
concurrency:
  group: ${{ github.workflow }}-${{ github.event_name == 'pull_request' && github.head_ref || github.sha }}
  cancel-in-progress: true

jobs:
  lint:
    if: (github.event_name == 'pull_request' && github.base_ref == 'master' && !github.event.pull_request.draft) || (github.event_name == 'push' && github.ref == 'refs/heads/master')
    runs-on: ubuntu-20.04
    env:
      CC: gcc
    steps:
      - uses: actions/checkout@v2

      - name: Setup common environment variables
        run: ./.github/workflows/env.sh lint

      - name: Install apt packages
        run: |
          sudo add-apt-repository ppa:neovim-ppa/stable
          sudo apt-get update
          sudo apt-get install -y \
            autoconf \
            automake \
            build-essential \
            ccache \
            cmake \
            flake8 \
            gettext \
            gperf \
            libluajit-5.1-dev \
            libmsgpack-dev \
            libtermkey-dev \
            libtool-bin \
            libtree-sitter-dev \
            libunibilium-dev \
            libuv1-dev \
            libvterm-dev \
            locales \
            lua-busted \
            lua-check \
            lua-filesystem \
            lua-inspect \
            lua-lpeg \
            lua-luv-dev \
            lua-nvim \
            luajit \
            ninja-build \
            pkg-config

      - name: Cache artifacts
        uses: actions/cache@v2
        with:
          path: |
            ~/.ccache
          key: lint-${{ hashFiles('cmake/*', '**/CMakeLists.txt', '!third-party/**CMakeLists.txt') }}-${{ github.base_ref }}

      - name: Build nvim
        run: ./ci/run_tests.sh build

      - if: "!cancelled()"
        name: clint
        run: ./ci/run_lint.sh clint

      - if: "!cancelled()"
        name: lualint
        run: ./ci/run_lint.sh lualint

      - if: "!cancelled()"
        name: pylint
        run: ./ci/run_lint.sh pylint

      - if: "!cancelled()"
        name: shlint
        run: ./ci/run_lint.sh shlint

      - if: "!cancelled()"
        name: single-includes
        run: ./ci/run_lint.sh single-includes

      - name: Cache dependencies
        run: ./ci/before_cache.sh

      - if: failure()
        name: Fail Summary
        run: cat "$COMPLETE_FAIL_SUMMARY_FILE"
